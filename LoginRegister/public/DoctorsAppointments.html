<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DoctorsAppointments</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <style>
        .Logo {
    height: 3rem;
    width: 3rem;
    margin-left: 2rem;
    margin-right: 2rem;
  }
  #nav {
    background-color: #4caf50 !important;
  }
  a {
    color: black !important;
    font-weight: 600 !important;
    text-decoration: none;
  }
  a:hover {
    color: white !important;
  }
  .dropdown-item:hover {
    color: #4caf50 !important;
  }
  .btn {
    font-weight: 600;
    background-color: white;
  }
  /*Below for Footer*/
  .footer-container,.py-3{
    background-color: #4caf50;
  }
    .click{
      width: 100%;
      height: 2px;
      background-color: white;
      margin: 10px 0;
    }
    /*appointment*/
        .container{
          max-width: 1000px;
          margin: 30px auto;
          background-color: white;
          padding: 2%;
          border-radius: 8px;
          box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
          
        }
         h2{
          color: #333;
          margin-bottom: 1.5rem;
          text-align: center;
          padding: 20px;
          font-weight: bold;
         }
         label{
          display: block;
          margin-bottom: 0.5rem;
          font-weight: bold;
          color: #444;
         }
         input[type="text"]:focus, input[type="date"]:focus, input[type="number"]:focus, select:focus{
        border-color: #424242;
        outline: none;
        padding: 0.6rem;
        
         }
         .error {
        color: red;
        font-size: 0.875rem;
        margin-top: 0.25rem;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
      }
         .submit{
            text-align: center;
            margin-top: 2px;
         }
         .submit-button{
    font-size: 16px;
    font-weight: 500;
    padding: 12px 35px;
    color: white;
    border-radius: 40px;
    display: inline-block;
    white-space: nowrap;
    border: none;
    background: black;
    transition: all 0.3s ease;
    margin-top: 50px;
        }
     .submit button:hover{
        background-color: green;
     }
         
    optgroup{
        font-style: normal;
        font-weight: bold;
        color: #333;
        padding: 0.5rem 0;
    }
    optgroup option{
        font-weight: bold;
        padding: 0.5rem 0;
    }
    input, select, option{
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
    }
    /*Footer Section*/
    .footer-container,.py-3{
        background-color: #4caf50;
      }
      .nav-link{
        color: black !important;
        font-weight: 600 !important;
      }
      .nav-link:hover {
        color:white !important;
      }
      body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
      }
    </style>
</head>
<body>

  <nav id="nav" class="navbar navbar-expand-lg bg-body-tertiary">
    <div class="container-fluid">
      <img
        class="Logo"
        src="./Resources/pixelcut-export.png"
        alt="Medico-Logo"
      />
      <button
        class="navbar-toggler"
        type="button"
        data-bs-toggle="collapse"
        data-bs-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="MediGo.html">Home</a>
          </li>
          <li class="nav-item dropdown">
            <a
              class="nav-link dropdown-toggle"
              href="#"
              role="button"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            >
              Services
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="SymptomChecker.html">Symptom Checker</a></li>
              <li><a class="dropdown-item" href="healthy.html">Health Articles</a></li>
              <li><hr class="dropdown-divider" /></li>
              <li>
                <a class="dropdown-item" href="DoctorsAppointments.html">Doctor Appointments</a>
              </li>
            </ul>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="contact us.html">Contact Us</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="aboutus.html">About Us</a>
          </li>
        </ul>
        <!--for profile-->
        <div class="btn-group">
          <button type="button" class="btn btn-outline-success dropdown-toggle mb-lg-0 mb-3 me-3 " data-bs-toggle="dropdown" data-bs-display="static" aria-expanded="false">
            Your Profile
          </button>
          <ul class="dropdown-menu dropdown-menu-lg-end">
            <li><a href="YourAppointments.html"><button class="dropdown-item" type="button">Your Appointments</button></a></li>
            <li><a href="UserEditProfile.html"><button class="dropdown-item" type="button">Edit Profile</button></a></li>
            <li><hr class="dropdown-divider" /></li>
            <li><button class="dropdown-item" type="button" onclick="logout()">Log Out</button></li>
          </ul>
        </div>
        <button class="btn btn-outline-success btnn" type="button" onclick="history.back()">
            Back
        </button>
      </div>
    </div>
  </nav>

    
    <form id="DoctorsAppointments" action="/auth/DoctorsAppointments" method="POST">
    <div class="container">
       <h2>Doctors Appointment</h2><hr>
    <div class="first-name">
        <label>First-Name:</label>
        <input type="text" placeholder="Enter First-Name" id="first_name" name="first_name"  required>
        <div class="error" id="first_name_error"></div>
    </div>
    <div class="last name">
        <label>Last-Name:</label>
        <input type="text" id="last_name" placeholder="Enter Last-Name" name="last_name">
        <span class="error" id="last_name_error"></span>
    </div>
    <div class="dob">
        <label>Date-Of-Birth:</label>
        <input type="date" name="dob" id="dob" onchange="validateDOB()" required>
        <div class="error" id="dobError"></div>
    </div>
    <div class="age">
        <label>Age:</label>
        <input type="text" id="age" name="age" required>
        <span class="error" id="age_error"></span>
    </div>
    <div class="gender">
        <label>Gender:</label>
        <select name="gender" required>
            <option value="">Please Select</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
            <option value="Transgender">Transgender</option>
            <option value="Not Willing">Not Willing To Ask</option>
        </select>
        <div class="error" id="SelectError"></div>
    </div>
    <div class="email">
        <label for="">E-mail:</label>
        <input type="text" id="email" name="email" readonly>
        <div class="error" id="emailError"></div>
    </div>
    <div class="phone-no">
        <label for="">Mobile-No:</label>
        <input type="text" placeholder="00000 00000" name="phone_number" required>
        <span class="error" id="phone_error"></span>
    </div>
    <div class="address line-1">
        <label for="">Address Line 1:</label>
        <input type="text" placeholder="Door-no & Street Name" name="address1" required>
    </div>
    <div class="address line-2">
        <label for="">Address Line 2:</label>
        <input type="text" placeholder=" District-Name & State-Name,pin-code" name="address2" required>
    </div>
    <div class="appoinment-date">
        <label>Appoinment-Date:</label>
        <input type="date" id="appointmentDate" name="appointment_date" required>
        <span class="error" id="appointmentError"></span>
    </div>
    <div>
      <label for="doctor-specialty">Choose a doctor specialty:</label>
      <select id="doctor-specialty" name="doctor_specialty" required >
        <option value="">Please Select</option>
        <optgroup label="General">
            <option value="General Physician">General Physician</option>
            <option value="Family Doctor">Family Doctor</option>
        </optgroup>

        <optgroup label="Specialists">
            <option value="Cardiologist">Cardiologist</option>
            <option value="Dermatologist">Dermatologist</option>
            <option value="Neurologist">Neurologist</option>
            <option value="Gastroenterologist">Gastroenterologist</option>
            <option value="Psychiatrist">Psychiatrist</option>
        </optgroup>

        <optgroup label="Surgical Specialists">
            <option value="General Surgeon">General Surgeon</option>
            <option value="Orthopedic Surgeon">Orthopedic Surgeon</option>
            <option value="Neurosurgeon">Neurosurgeon</option>
            <option value="Cardiac Surgeon">Cardiac Surgeon</option>
        </optgroup>

        <optgroup label="Women & Child Health">
            <option value="Gynecologist">Gynecologist & Obstetrician</option>
            <option value="Pediatrician">Pediatrician</option>
        </optgroup>

        <optgroup label="ENT & Eye Care">
            <option value="Ophthalmologist">Ophthalmologist (Eye Specialist)</option>
            <option value="ENT Specialist">ENT Specialist</option>
        </optgroup>

        <optgroup label="Alternative Medicine">
            <option value="Ayurvedic Doctor">Ayurvedic Doctor</option>
            <option value="Homeopathy Doctor">Homeopathy Doctor</option>
        </optgroup>

        <optgroup label="Other Specialists">
            <option value="Dentist">Dentist</option>
            <option value="Urologist">Urologist</option>
            <option value="Sexologist">Sexologist</option>
        </optgroup>
      </select>
      <div class="error" id="SelectError"></div>
    </div>

    <div class="choose-doctor">
     <button type="button">Choose Doctor</button>
      
  </div>

    <div class="doctor-id">
      <label for="doctorId">Doctor ID:</label>
      <input type="text" id="doctorId" name="doctor_id" readonly>
  </div>
  <div class="Appoinment-Time">
    <label>Appointment Time:</label>
    <input type="text" id="appointmentTime" name="appointment_time" name="appointment_time" readonly>
</div>
    

  <div class="submit">
        <button class="submit-button" onclick="validateForm()">Submit</button>
    </div> 
    </div>
</form>
<div class="footer-container">
  <footer class="py-3">
    <ul class="nav justify-content-center border-bottom pb-3 mb-3">
      <li class="nav-item"><a href="MediGo.html" class="nav-link px-2 " style="color: black;">Home</a></li>
      <li class="nav-item"><a href="contact us.html" class="nav-link px-2 " style="color: black;">Contact Us</a></li>
      <li class="nav-item"><a href="aboutus.html" class="nav-link px-2 " style="color: black;">About Us</a></li>
    </ul>
    <p class="text-center" style="color: black;">© 2025 Medigo. All Rights Reserved.</p>
  </footer>
</div>

<script>
  // ✅ Function to calculate age automatically
function calculateAge(dob) {
    if (!dob) return "";

    const birthDate = new Date(dob);
    const today = new Date();
    let age = today.getFullYear() - birthDate.getFullYear();
    const monthDiff = today.getMonth() - birthDate.getMonth();

    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
        age--; // Adjust if birthdate hasn't occurred yet this year
    }

    return age >= 0 ? age : "";
}

// ✅ Automatically update age field when DOB is selected
document.addEventListener("DOMContentLoaded", function () {
    const dobInput = document.getElementById("dob");
    const ageInput = document.getElementById("age");

    dobInput.addEventListener("input", function () {
        const dobValue = dobInput.value;
        const calculatedAge = calculateAge(dobValue);

        ageInput.value = calculatedAge;

        // ✅ Show error if the age is invalid
        const dobError = document.getElementById("dobError");
        if (calculatedAge === "") {
            dobError.textContent = "Please enter a valid Date of Birth.";
        } else {
            dobError.textContent = "";
        }
    });
});


  // ✅ Function to validate the entire form
function validateForm() {
    let isValid = true;

    const firstname = document.getElementById("first_name").value.trim();
    const dob = document.getElementById("dob").value.trim();
    const email = document.getElementById("email").value.trim();
    const phone = document.querySelector("input[name='phone_number']").value.trim();
    const appointmentDate = document.getElementById("appointmentDate").value.trim();
    const doctorSpecialty = document.getElementById("doctor-specialty").value.trim();
    const doctorId = document.getElementById("doctorId").value.trim();
    const appointmentTime = document.getElementById("appointmentTime").value.trim();

    const errors = {
        firstname: validateFirstname(firstname),
        dob: validateDob(dob),
        email: validateEmail(email),
        phone: validatePhoneNumber(phone),
        appointmentDate: validateAppointmentDate(appointmentDate),
        doctorSpecialty: doctorSpecialty === "" ? "Doctor Specialty is required." : "",
        doctorId: doctorId === "" ? "Doctor selection is required." : "",
        appointmentTime: appointmentTime === "" ? "Appointment Time is required." : ""
    };

    Object.keys(errors).forEach((field) => {
        const errorElement = document.getElementById(`${field}Error`);
        if (errorElement) {
            errorElement.textContent = errors[field];
        }
        if (errors[field]) isValid = false;
    });

    return isValid;
}

// ✅ Function to validate First Name
function validateFirstname(value) {
    if (value === "") return "First Name is required.";
    if (!/^[a-zA-Z\s]+$/.test(value)) return "First Name must contain only letters.";
    return "";
}

// ✅ Function to validate Date of Birth
function validateDob(value) {
    if (value === "") return "Date of Birth is required.";
    const dob = new Date(value);
    const today = new Date();
    if (dob >= today) return "Date of Birth must be in the past.";
    return "";
}

// ✅ Function to validate Email
function validateEmail(value) {
    if (value === "") return "Email is required.";
    if (!/^\S+@\S+\.\S+$/.test(value)) return "Invalid email format.";
    return "";
}

// ✅ Function to validate Phone Number
function validatePhoneNumber(value) {
    if (value === "") return "Phone Number is required.";
    if (!/^\d{10}$/.test(value)) return "Phone Number must be 10 digits.";
    return "";
}

// ✅ Function to validate Appointment Date
function validateAppointmentDate(value) {
    if (value === "") return "Appointment Date is required.";
    const today = new Date().toISOString().split("T")[0];
    if (value < today) return "Appointment Date cannot be in the past.";
    return "";
}


document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("DoctorsAppointments");

    // ✅ Declare `inputs` globally so it can be used in multiple event listeners
    const inputs = {
        firstname: document.getElementById("first_name"),
        dob: document.getElementById("dob"),
        email: document.getElementById("email"),
        age: document.getElementById("age"),
        phone: document.querySelector("input[name='phone_number']"),
        appointmentDate: document.getElementById("appointmentDate"),
        doctorSpecialty: document.getElementById("doctor-specialty"),
        doctorId: document.getElementById("doctorId"),
        appointmentTime: document.getElementById("appointmentTime")
    };

    form.addEventListener("submit", function (e) {
        e.preventDefault(); // Prevent default form submission

        let isValid = true;

        const errors = {
            firstname: validateFirstname(inputs.firstname.value.trim()),
            dob: validateDob(inputs.dob.value),
            email: validateEmail(inputs.email.value.trim()),
            phone: validatePhoneNumber(inputs.phone.value.trim()),
            appointmentDate: validateAppointmentDate(inputs.appointmentDate.value),
            doctorSpecialty: inputs.doctorSpecialty.value.trim() === "" ? "Doctor Specialty is required." : "",
            doctorId: inputs.doctorId.value.trim() === "" ? "Doctor selection is required." : "",
            appointmentTime: inputs.appointmentTime.value.trim() === "" ? "Appointment Time is required." : ""
        };

        // Display validation errors
        Object.keys(errors).forEach((field) => {
            const errorElement = document.getElementById(`${field}Error`);
            if (errorElement) {
                errorElement.textContent = errors[field];
            }
            if (errors[field]) isValid = false;
        });

        if (!isValid) {
            return; // Stop submission if any validation fails
        }

        const formData = {
            first_name: inputs.firstname.value.trim(),
            last_name: document.getElementById("last_name").value.trim(),
            dob: inputs.dob.value.trim(),
            age: inputs.age.value.trim(),
            gender: document.querySelector("select[name='gender']").value.trim(),
            email: inputs.email.value.trim(),
            phone_number: inputs.phone.value.trim(),
            address1: document.querySelector("input[name='address1']").value.trim(),
            address2: document.querySelector("input[name='address2']").value.trim(),
            appointment_date: inputs.appointmentDate.value.trim(),
            appointment_time: inputs.appointmentTime.value.trim(),
            doctor_specialty: inputs.doctorSpecialty.value.trim(),
            doctor_id: inputs.doctorId.value.trim()
        };

        console.log("Submitting form data:", formData); // Debugging

        // ✅ Send data to the backend
        fetch(form.action, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            console.log("Response from server:", data);

            // ✅ Show success message
            alert("Appointment booked successfully!");

            // ✅ Clear form fields
            form.reset();

            // ✅ Clear `localStorage`
            localStorage.removeItem("appointmentFormData");
            localStorage.removeItem("selectedDoctorId");
            localStorage.removeItem("selectedAppointmentTime");
            localStorage.removeItem("selectedSpecialty");

            // ✅ Redirect after successful submission
            setTimeout(() => {
                window.location.href = "DoctorsAppointments.html"; // Reload the form page
            }, 1000);
        })
        .catch(error => {
            console.error("Error submitting form:", error);
            alert("Error submitting the form. Please try again.");
        });
    });

    // ✅ Real-time validation (Fixing the `inputs` reference)
    inputs.firstname.addEventListener("input", () => {
        document.getElementById("first_name_error").textContent = validateFirstname(inputs.firstname.value.trim());
    });

    inputs.email.addEventListener("input", () => {
        document.getElementById("emailError").textContent = validateEmail(inputs.email.value.trim());
    });

    inputs.dob.addEventListener("input", () => {
        const dobValue = inputs.dob.value;
        const dobError = document.getElementById("dobError");
        const ageField = inputs.age;

        const errorMessage = validateDob(dobValue);
        dobError.textContent = errorMessage;

        if (!errorMessage) {
            ageField.value = calculateAge(dobValue);
        } else {
            ageField.value = "";
        }
    });

    inputs.phone.addEventListener("input", () => {
        document.getElementById("phone_error").textContent = validatePhoneNumber(inputs.phone.value.trim());
    });

    inputs.appointmentDate.addEventListener("input", () => {
        document.getElementById("appointmentError").textContent = validateAppointmentDate(inputs.appointmentDate.value);
    });
});


//below choose doctors codes are writtened
document.addEventListener("DOMContentLoaded", function () {
    const chooseDoctorBtn = document.querySelector(".choose-doctor button");

    chooseDoctorBtn.addEventListener("click", function () {
        const specialtyDropdown = document.getElementById("doctor-specialty");

        if (!specialtyDropdown) {
            alert("Doctor specialty dropdown not found!");
            return;
        }

        const selectedSpecialty = specialtyDropdown.value.trim(); // Trim to remove accidental spaces

        if (!selectedSpecialty || selectedSpecialty === "") {
            alert("Please select a doctor specialty first.");
            return;
        }

        console.log("Saving selected specialty to localStorage:", selectedSpecialty); // Debugging

        // ✅ Store the selected specialty in localStorage
        localStorage.setItem("selectedSpecialty", selectedSpecialty);

        // ✅ Store all form data before redirecting
        const formData = {
            first_name: document.getElementById("first_name").value || "",
            last_name: document.getElementById("last_name").value || "",
            dob: document.getElementById("dob").value || "",
            age: document.getElementById("age").value || "",
            gender: document.querySelector("select[name='gender']").value || "",
            email: document.getElementById("email").value || "",
            phone_number: document.querySelector("input[name='phone_number']").value || "",
            address1: document.querySelector("input[name='address1']").value || "",
            address2: document.querySelector("input[name='address2']").value || "",
            appointment_date: document.getElementById("appointmentDate").value || "",
            doctor_specialty: selectedSpecialty
        };

        localStorage.setItem("appointmentFormData", JSON.stringify(formData));

        // ✅ Redirect to Choose Doctors
        setTimeout(() => {
            console.log("Redirecting... localStorage:", localStorage.getItem("selectedSpecialty"));
            window.location.href = "ChooseDoctors.html";
        }, 100); // Small delay to ensure localStorage is updated
    });
});

document.addEventListener("DOMContentLoaded", function () {
    // Detect if the page was manually refreshed
    if (performance.getEntriesByType("navigation")[0].type === "reload") {
        console.log("Page was manually refreshed. Clearing form data...");
        localStorage.clear();
        document.getElementById("DoctorsAppointments").reset();
    } else {
        // ✅ Load stored data if the page is accessed normally (e.g., returning from ChooseDoctors.html)
        const storedData = JSON.parse(localStorage.getItem("appointmentFormData"));
        const selectedDoctorId = localStorage.getItem("selectedDoctorId");
        const selectedAppointmentTime = localStorage.getItem("selectedAppointmentTime");

        if (storedData) {
            document.getElementById("first_name").value = storedData.first_name || "";
            document.getElementById("last_name").value = storedData.last_name || "";
            document.getElementById("dob").value = storedData.dob || "";
            document.getElementById("age").value = storedData.age || "";
            document.querySelector("select[name='gender']").value = storedData.gender || "";
            document.getElementById("email").value = storedData.email || "";
            document.querySelector("input[name='phone_number']").value = storedData.phone_number || "";
            document.querySelector("input[name='address1']").value = storedData.address1 || "";
            document.querySelector("input[name='address2']").value = storedData.address2 || "";
            document.getElementById("appointmentDate").value = storedData.appointment_date || "";
            document.getElementById("doctor-specialty").value = storedData.doctor_specialty || "";
        }

        if (selectedDoctorId) document.getElementById("doctorId").value = selectedDoctorId;
        if (selectedAppointmentTime) document.getElementById("appointmentTime").value = selectedAppointmentTime;
    }
});


window.addEventListener("beforeunload", function () {
    if (window.location.pathname == "/ChooseDoctors.html") {
        localStorage.removeItem("appointmentFormData"); // Clear stored form data
        localStorage.removeItem("selectedDoctorId"); // Clear selected doctor ID
        localStorage.removeItem("selectedAppointmentTime"); // Clear selected appointment time
        localStorage.removeItem("selectedSpecialty"); // Clear selected specialty
    }
});

//page refresh
document.addEventListener("DOMContentLoaded", function () {
    if (!localStorage.getItem("appointmentFormData")) {
        document.getElementById("DoctorsAppointments").reset();
    }
});
//using session to store emial-id automaticaly
document.addEventListener("DOMContentLoaded", function () {
    fetch("http://localhost:3005/auth/getLoggedInUser")
        .then(response => response.json())
        .then(data => {
            if (data.email) {
                document.getElementById("email").value = data.email;
            } else {
                alert("Please log in to proceed.");
                window.location.href = "login.html";
            }
        })
        .catch(error => {
            console.error("Error fetching logged-in user email:", error);
        });
});
// for storing email-id automaticaly from session
document.addEventListener("DOMContentLoaded", function () {
    fetch("http://localhost:3005/auth/getLoggedInUser")
        .then(response => response.json())
        .then(data => {
            if (data.email) {
                document.getElementById("email").value = data.email;
            } else {
                window.location.href = "login.html"; // Redirect to login if not logged in
            }
        })
        .catch(error => {
            console.error("Error fetching logged-in user email:", error);
        });
});


</script>
  

</body>
</html>